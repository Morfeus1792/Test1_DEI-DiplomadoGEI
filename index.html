<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen: Diseño de Edificios Inteligentes v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; --innotica-blue: #00448D; --innotica-yellow: #FDB813; }
        .bg-innotica-blue { background-color: var(--innotica-blue); }
        .text-innotica-blue { color: var(--innotica-blue); }
        .bg-innotica-yellow { background-color: var(--innotica-yellow); }
        .border-innotica-blue { border-color: var(--innotica-blue); }
        .ring-innotica-blue { --tw-ring-color: var(--innotica-blue); }
        .hover\:bg-innotica-blue-dark:hover { background-color: #003366; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-innotica-blue">Examen: Diseño de Edificios Inteligentes v6</h1>
                <p class="text-gray-600 mt-2">Evaluación de las clases 1 y 2 del Módulo 3.</p>
            </header>

            <div id="student-info-section">
                <form id="student-info-form" class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Información del Estudiante</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-innotica-blue" required>
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                            <input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-innotica-blue" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="email" name="email" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-innotica-blue" required>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button type="submit" class="bg-innotica-blue text-white font-bold py-2 px-6 rounded-lg hover:bg-innotica-blue-dark">Comenzar Examen</button>
                    </div>
                </form>
            </div>

            <div id="quiz-section" class="hidden">
                <div class="flex justify-between items-center mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div id="progress-container" class="w-full mr-4">
                         <p id="progress-text" class="text-sm text-gray-600 mb-1">Progreso</p>
                         <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-innotica-yellow h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-sm text-gray-600">Tiempo</p>
                        <div id="timer" class="text-lg font-semibold text-innotica-blue">00:00</div>
                    </div>
                </div>
                <div id="quiz-container"></div>
                <div id="navigation-container" class="flex justify-between mt-6"></div>
            </div>

            <div id="evaluation-section" class="hidden text-center p-8">
                 <h2 class="text-2xl font-bold text-innotica-blue mb-4">Evaluando tus respuestas...</h2>
                 <p class="text-gray-600 mb-4">Por favor, espera un momento.</p>
                 <div class="w-full bg-gray-200 rounded-full h-4"><div id="evaluation-bar" class="bg-innotica-blue h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            </div>

            <div id="results-container" class="hidden text-center mt-8"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800">Confirmar Finalización</h3>
            <p class="text-gray-600 text-center mb-6">¿Estás seguro de que deseas finalizar el examen?</p>
            <div class="flex justify-around">
                <button id="cancel-finish-btn" class="px-6 py-2 bg-gray-200 rounded-lg">Cancelar</button>
                <button id="confirm-finish-btn" class="px-6 py-2 bg-innotica-blue text-white rounded-lg">Finalizar</button>
            </div>
        </div>
    </div>

    <script>
        const quizData = [
            { question: "1. ¿Cuáles son los cuatro pilares fundamentales de la automatización de edificios?", options: ["Luz, Agua, Gas, Internet", "Cimientos, Estructura, Techo, Paredes", "Energía, Confort, Seguridad, Comunicación", "Sensores, Actuadores, Cables, Software", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! La automatización busca un equilibrio entre eficiencia energética, confort, seguridad y comunicación." } },
            { question: "2. Un sensor de flujo que indica litros por minuto emite una señal:", options: ["Digital", "Analógica", "Binaria", "De alarma", "Todas las anteriores", "Ninguna de las anteriores"], correct: 1, feedback: { 1: "¡Correcto! Representa una variación continua." } },
            { question: "3. ¿Qué actuador se necesita para posicionar una válvula en puntos intermedios (ej. 70%)?", options: ["Todo/Nada", "On/Off", "Digital", "Proporcional", "Todas las anteriores", "Ninguna de las anteriores"], correct: 3, feedback: { 3: "¡Correcto! Solo un actuador proporcional puede regular una posición variable."} },
            { question: "4. ¿Cuál es la función principal del 'Front-end' en un BMS?", options: ["Almacenar datos históricos.", "Ejecutar la lógica de control.", "Proporcionar la interfaz gráfica (SCADA) para el usuario.", "Conectar los sensores.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! El Front-end es la parte visual e interactiva del sistema." } },
            { question: "5. ¿Cuál es la ventaja clave de usar un protocolo estándar como BACnet?", options: ["Es más barato.", "Permite interoperabilidad entre diferentes fabricantes.", "Tiene mejor soporte técnico.", "Es más seguro.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 1, feedback: { 1: "¡Correcto! La interoperabilidad evita la dependencia de una sola marca." } },
            { question: "6. ¿Qué es el Facility Management?", options: ["El proceso de construcción.", "La gestión de un solo sistema.", "Una disciplina que gestiona el funcionamiento integral de los inmuebles y sus servicios.", "El equipo de limpieza.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! El FM tiene un alcance holístico para asegurar la eficiencia."} },
            { question: "7. ¿Qué función principal desempeña un 'Integrador'?", options: ["Diseñar los planos.", "Fabricar los dispositivos.", "Vender los inmuebles.", "Programar y hacer que distintas tecnologías funcionen juntas.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 3, feedback: { 3: "¡Correcto! El integrador es el especialista técnico que unifica los subsistemas." } },
            { question: "8. ¿Para qué se utiliza la metodología BIM en un proyecto inteligente?", options: ["Solo para renders 3D.", "Para la contabilidad.", "Para crear un modelo digital centralizado con toda la información del edificio.", "Para la certificación energética.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! BIM es un modelo de datos que integra todas las disciplinas del proyecto." } },
            { question: "9. ¿Cuál es el rol de un 'Agente de Comisionamiento'?", options: ["Vendedor de equipos.", "Limpieza de obra.", "Verificar que los sistemas instalados funcionen según el diseño.", "Director del proyecto.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! El comisionamiento es un proceso de aseguramiento de la calidad." } },
            { question: "10. ¿Qué tecnología inalámbrica está diseñada para bajo consumo y largas distancias (LPWAN)?", options: ["Wi-Fi 6", "5G", "Bluetooth", "LoRaWAN", "Todas las anteriores", "Ninguna de las anteriores"], correct: 3, feedback: { 3: "¡Correcto! LoRaWAN está optimizada para IoT, enviando pocos datos a largas distancias." } },
            { question: "11. La estrategia de usar un sensor de luz natural para regular las luces artificiales se conoce como:", options: ["Control por horario", "Control por presencia", "Daylight Harvesting", "Control ON/OFF", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! Usa la luz natural para reducir el consumo eléctrico." } },
            { question: "12. ¿Qué significa que un controlador tiene 'Entradas/Salidas Universales'?", options: ["Funciona con cualquier marca.", "Se conecta a cualquier red.", "Sus puertos físicos son configurables por software (entrada/salida, digital/analógica).", "Tiene un puerto USB.", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! Las I/O universales ofrecen gran flexibilidad en la instalación." } },
            { question: "13. El ciclo 'Medir, Analizar, Actuar y Supervisar' es un proceso de:", options: ["Instalación única", "Mejora continua", "Diseño inicial", "Mantenimiento correctivo", "Todas las anteriores", "Ninguna de las anteriores"], correct: 1, feedback: { 1: "¡Correcto! Es un ciclo iterativo para encontrar nuevas optimizaciones." } },
            { question: "14. ¿Qué actor del mercado se enfoca en crear normativas como LEED?", options: ["Promotor", "Constructor", "Organizaciones Gremiales (Ej. Green Building Council)", "Instalador", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! Estas organizaciones desarrollan y promueven estándares de construcción sostenible." } },
            { question: "15. ¿En qué fase de un proyecto se realiza la programación y el diseño del SCADA?", options: ["Pre-diseño", "Construcción", "Ingeniería de detalle", "Operación y Mantenimiento", "Todas las anteriores", "Ninguna de las anteriores"], correct: 2, feedback: { 2: "¡Correcto! La ingeniería de detalle traduce los requerimientos en soluciones técnicas y programación." } }
        ];

        // --- CONFIGURACIÓN ---
        // URL de la Web App de Google Apps Script.
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxCVuI-GwWlJKjIhKZ9-bJN2En9inY46qi2xOZfclPwvUWVD16uuWkGDcd3dUNwMOGb/exec';

        // --- ELEMENTOS DEL DOM ---
        const studentInfoSection = document.getElementById('student-info-section');
        const studentInfoForm = document.getElementById('student-info-form');
        const quizSection = document.getElementById('quiz-section');
        const quizContainer = document.getElementById('quiz-container');
        const navigationContainer = document.getElementById('navigation-container');
        const timerEl = document.getElementById('timer');
        const evaluationSection = document.getElementById('evaluation-section');
        const resultsContainer = document.getElementById('results-container');
        const confirmationModal = document.getElementById('confirmation-modal');
        
        // --- VARIABLES DE ESTADO ---
        let currentQuestionIndex = 0;
        let studentAnswers = new Array(quizData.length).fill(null);
        let studentInfo = {};
        let timerInterval;
        let seconds = 0;

        // --- LÓGICA DEL EXAMEN ---
        document.addEventListener('DOMContentLoaded', () => {
            studentInfoForm.addEventListener('submit', startQuiz);
            document.getElementById('cancel-finish-btn').addEventListener('click', () => confirmationModal.classList.add('hidden'));
            document.getElementById('confirm-finish-btn').addEventListener('click', finishQuiz);
        });

        function startQuiz(e) { e.preventDefault(); studentInfo.firstName = document.getElementById('firstName').value; studentInfo.lastName = document.getElementById('lastName').value; studentInfo.email = document.getElementById('email').value; if (studentInfo.firstName && studentInfo.lastName && studentInfo.email) { studentInfoSection.classList.add('hidden'); quizSection.classList.remove('hidden'); startTimer(); displayQuestion(); } }
        function displayQuestion() { const q = quizData[currentQuestionIndex]; quizContainer.innerHTML = `<div class="bg-gray-50 p-6 rounded-lg shadow-inner"><p class="mb-6 text-lg text-gray-800">${q.question}</p><div class="space-y-3">${q.options.map((o, i) => `<div class="option bg-white p-4 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-innotica-blue cursor-pointer" data-index="${i}"><label class="w-full h-full block cursor-pointer">${o}</label></div>`).join('')}</div></div>`; if (studentAnswers[currentQuestionIndex] !== null) { quizContainer.querySelector(`[data-index='${studentAnswers[currentQuestionIndex]}']`).classList.add('bg-blue-100', 'border-innotica-blue'); } quizContainer.querySelectorAll('.option').forEach(o => o.addEventListener('click', selectAnswer)); updateNavigation(); updateProgressBar(); }
        function selectAnswer(e) { const i = parseInt(e.currentTarget.dataset.index); studentAnswers[currentQuestionIndex] = i; quizContainer.querySelectorAll('.option').forEach(o => o.classList.remove('bg-blue-100', 'border-innotica-blue')); e.currentTarget.classList.add('bg-blue-100', 'border-innotica-blue'); }
        function updateNavigation() { navigationContainer.innerHTML = `<button id="prev-btn" class="px-6 py-2 bg-gray-300 rounded-lg ${currentQuestionIndex === 0 ? 'invisible' : ''}">Anterior</button>${currentQuestionIndex === quizData.length - 1 ? `<button id="finish-btn" class="px-6 py-2 bg-innotica-blue text-white font-bold rounded-lg">Finalizar</button>` : `<button id="next-btn" class="px-6 py-2 bg-innotica-blue text-white rounded-lg">Siguiente</button>`}`; if (currentQuestionIndex > 0) document.getElementById('prev-btn').addEventListener('click', handlePrevQuestion); if (currentQuestionIndex < quizData.length - 1) document.getElementById('next-btn').addEventListener('click', handleNextQuestion); else document.getElementById('finish-btn').addEventListener('click', () => confirmationModal.classList.remove('hidden')); }
        function handleNextQuestion() { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; displayQuestion(); } }
        function handlePrevQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(); } }
        function finishQuiz() { confirmationModal.classList.add('hidden'); quizSection.classList.add('hidden'); evaluationSection.classList.remove('hidden'); clearInterval(timerInterval); let p = 0; const i = setInterval(() => { p += 20; document.getElementById('evaluation-bar').style.width = `${p}%`; if (p >= 100) { clearInterval(i); setTimeout(() => { evaluationSection.classList.add('hidden'); showResults(); }, 500); } }, 1000); }
        async function showResults() { resultsContainer.classList.remove('hidden'); const c = studentAnswers.filter((a, i) => a === quizData[i].correct).length; const s = ((c / quizData.length) * 40).toFixed(2); resultsContainer.innerHTML = `<h2 class="text-3xl font-bold text-innotica-blue mb-4">Resultados</h2><p class="text-xl mb-2">Puntuación Final:</p><p class="text-5xl font-bold text-innotica-blue mb-6">${s} / 40.00</p><div id="submission-status" class="my-4 p-3 rounded-lg bg-gray-100 text-gray-700">Guardando resultados...</div><div class="text-left space-y-6">${quizData.map((q, i) => { const u = studentAnswers[i]; const r = u === q.correct; const f = r ? q.feedback[u] : 'Respuesta incorrecta.'; return `<div class="p-4 rounded-lg ${r ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}"><p class="font-bold">${q.question}</p><p class="mt-2">Tu respuesta: <span class="font-semibold">${u !== null ? q.options[u] : 'No respondida'}</span></p><p class="mt-2 text-sm ${r ? 'text-green-700' : 'text-red-700'}">${f}</p></div>`; }).join('')}</div><div class="mt-8"><button id="send-email-btn" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700">Preparar Correo</button></div>`; document.getElementById('send-email-btn').addEventListener('click', sendEmail); await saveResultsToBackend(s); }
        function startTimer() { timerInterval = setInterval(() => { seconds++; const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); timerEl.textContent = `${m}:${s}`; }, 1000); }
        function updateProgressBar() { document.getElementById('progress-text').textContent = `Pregunta ${currentQuestionIndex + 1} de ${quizData.length}`; document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / quizData.length) * 100}%`; }
        function sendEmail() { const s = ((studentAnswers.filter((a, i) => a === quizData[i].correct).length / quizData.length) * 40).toFixed(2); const t = "carlosdobobuto@gmail.com"; const j = `Resultados: ${studentInfo.firstName} ${studentInfo.lastName}`; let b = `Resultados del Examen:\nNombre: ${studentInfo.firstName} ${studentInfo.lastName}\nCorreo: ${studentInfo.email}\nTiempo: ${timerEl.textContent}\n\nPUNTUACIÓN: ${s} / 40.00\n\n------------------\n\n`; quizData.forEach((q, i) => { const u = studentAnswers[i]; const c = u === q.correct; const f = c ? q.feedback[u] : 'Respuesta incorrecta.'; b += `${q.question}\nRespuesta: ${u !== null ? q.options[u] : 'No respondida'} (${c ? 'Correcta' : 'Incorrecta'})\nFeedback: ${f}\n\n`; }); window.location.href = `mailto:${t}?subject=${encodeURIComponent(j)}&body=${encodeURIComponent(b)}`; }
        
        // --- FUNCIÓN PARA ENVIAR DATOS AL BACKEND ---
        async function saveResultsToBackend(finalScore) {
            const statusDiv = document.getElementById('submission-status');
            
            if (BACKEND_URL === 'https://script.google.com/macros/s/AKfycbxCVuI-GwWlJKjIhKZ9-bJN2En9inY46qi2xOZfclPwvUWVD16uuWkGDcd3dUNwMOGb/exec') {
                statusDiv.textContent = 'Error: La URL del backend no está configurada.';
                statusDiv.className = 'my-4 p-3 rounded-lg bg-red-100 text-red-800';
                return;
            }

            const payload = {
                firstName: studentInfo.firstName,
                lastName: studentInfo.lastName,
                email: studentInfo.email,
                finalScore: finalScore,
                totalTime: timerEl.textContent,
                answers: studentAnswers.map((answerIndex, i) => answerIndex !== null ? quizData[i].options[answerIndex] : 'No respondida')
            };

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Necesario para Google Apps Script
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    statusDiv.textContent = 'Resultados guardados automáticamente.';
                    statusDiv.className = 'my-4 p-3 rounded-lg bg-green-100 text-green-800';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error al guardar los resultados:', error);
                statusDiv.textContent = 'Error al guardar los resultados automáticamente.';
                statusDiv.className = 'my-4 p-3 rounded-lg bg-red-100 text-red-800';
            }
        }
    </script>
</body>
</html>
